// Exercise 4.1.1
module powerflow {
     solver_method NR;
};
module climate;
module generators;
module residential {
	implicit_enduses NONE;
};
module tape;



clock {
	timestamp '2023-01-01 00:00:00';
	stoptime '2023-01-01 00:10:00';
	// timezone PST+8PDT;
}
// IEEE 4 Node Feeder: Balanced step-down delta-delta

class player {
    double value;
}

object line_configuration {
	name LC300;
	conductor_A OH100;
	conductor_B OH100;
	conductor_C OH100;
	conductor_N OH101;
	spacing LS200;
}

object line_spacing {
	name LS200;
	distance_AB 2.5;
	distance_BC 4.5;
	distance_AC 7.0;
	distance_AN 5.656854;
	distance_BN 4.272002;
	distance_CN 5.0;
}


object overhead_line_conductor {
	name OH100;
	geometric_mean_radius 0.0244;
	resistance 0.306;
}

object overhead_line_conductor {
	name OH101;
	geometric_mean_radius 0.00814;
	resistance 0.592;
}


object transformer_configuration {
	name XFC400;
	connect_type 2;
	power_rating 6000;
	primary_voltage 12470;
	secondary_voltage 4160;
	resistance 0.01;
	reactance 0.06;
}

object transformer_configuration {
	name PoleTop;
	connect_type SINGLE_PHASE_CENTER_TAPPED;
	power_rating 400;
	powerA_rating 400;
	primary_voltage 2400;
	secondary_voltage 120;
	resistance 0.01;
	reactance 0.06;
}


object triplex_line_configuration {
      name triplex_line_config;
      conductor_1 Name_1_0_AA_triplex;
      conductor_2 Name_1_0_AA_triplex;
      conductor_N Name_1_0_AA_triplex;
      insulation_thickness 0.1;
      diameter 0.4;
}
object triplex_line_conductor {
      name Name_1_0_AA_triplex;
      resistance 0.57;
      geometric_mean_radius 0.0111;
}



//feeder head

object node {
	name Node1;
	bustype SWING;
	phases A|B|C;
	voltage_A +7199.558+0.000j;
	voltage_B -3599.779-6235.000j;
	voltage_C -3599.779+6235.000j;
	nominal_voltage 7199.558;
}

object overhead_line {
	name Link12;
	phases A|B|C;
	from Node1;
	to Node2;
	length 2000;
	configuration LC300;
	nominal_voltage 7199.558;
}

object node {
	name Node2;
	phases A|B|C;
	voltage_A +7199.558+0.000j;
	voltage_B -3599.779-6235.000j;
	voltage_C -3599.779+6235.000j;
	nominal_voltage 7199.558;
}

object transformer {
	name substation_transformer;
	phases A|B|C;
	from Node2;
	to substation_meter;
	configuration XFC400;
}

object meter {
      name substation_meter;
      phases ABCN;
      nominal_voltage 4160;
}
object recorder {
	name substation_meter_pl;
	parent substation_meter;
	property measured_voltage_A,measured_voltage_B,measured_voltage_C,measured_power;
	file ./gld_outputs/substation_meter_data.csv;
	interval 60;
  }
//Branch 1

object overhead_line {
	name branch;
	phases A|B|C;
	from substation_meter;
	to Node3;
	length 2000;
	configuration LC300;
	nominal_voltage 2401.777;
}
object node {
	name Node3;
	phases A|B|C;  										//Delta connected phases
	voltage_A +2401.777+0.000j;
	voltage_B -1200.889-2080.000j;
	voltage_C -1200.889+2080.000j;
	nominal_voltage 4160;
}

object overhead_line {
	name branch1;
	phases A|B|C;
	from Node3;
	to intermed_meter;
	length 2000;
	configuration LC300;
	nominal_voltage 4160;
}


object meter {
	phases ABC;
	nominal_voltage 4160;
	name intermed_meter;
}

object transformer {
	name Residential_xformer;
	phases AS;
	from intermed_meter;
	to Load_Meter;
	configuration PoleTop;
}

object triplex_meter {
	name Load_Meter;
	phases AS;
	nominal_voltage 240.0;
}
object recorder{
	name triplex_meter_pl_1;
	parent intermed_meter;
	property measured_real_power.real, voltage_A,voltage_B,voltage_C;
	// property measured_power.real,measured_power.imag,measured_power, voltage_1, voltage_2;
	file ./gld_outputs/xfmr_parent_meter.csv;
	interval 60;
}

object recorder{
	name triplex_meter_pl_2;
	parent Load_Meter;
	property measured_real_power.real, voltage_1, voltage_2;
	// property measured_power.real,measured_power.imag,measured_power, voltage_1, voltage_2;
	file ./gld_outputs/triplex_meter.csv;
	interval 60;
}

object triplex_load {
	name tlx_1;
	parent Load_Meter;
	phases AS;
	voltage_1 120.0;
	voltage_2 120.0;
	constant_power_12 house.value*20;
	nominal_voltage 240;
}


object inverter {
	name inv_bat;
	parent Load_Meter;
	phases AS;
	inverter_type FOUR_QUADRANT;
	four_quadrant_control_mode VOLT_VAR;
	generator_status ONLINE;
	generator_mode SUPPLY_DRIVEN;
	V_base 240;
	rated_power 5 kVA;// per phase;
	inverter_efficiency 0.87;
	P_Out player_A.value;
	Q_Out 0.000;
	//Volt Var parameters;
	V_base 240;
	V1 0.90;
	Q1 0.7;
	V2 0.95;
	Q2 0.0;
	V3 1.05;
	Q3 0.0;
	V4 1.10;
	Q4 -0.8;
	object battery {
		name bat;
		nominal_voltage 48;
		battery_capacity 7000;
		state_of_charge 1.0;
		use_internal_battery_model true;
		generator_mode CONSTANT_PQ;
		generator_status ONLINE;
		battery_type LI_ION;
		round_trip_efficiency 0.86;
		// rated_power 5000;

	};
}

object recorder {
	name Load_meter_pl;
	parent inv_bat;
	property VA_Out, VA_Out.real;
	// property Pref,Qref,VA_Out.real;
	// property "power_A.real,power_A.imag, power_B.real,power_B.imag, power_C.real,power_C.imag, VA_Out.real, VA_Out.imag, Pref, Qref";
	file ./gld_outputs/load.csv;
	interval 1;
}

object recorder{
	name bat_rec;
	parent bat;
	property rated_power,state_of_charge,battery_load;
	file ./gld_outputs/bat.csv;
	interval 1;
}

object player {
	name player_A;
	file "ders.csv";
}

object player {
	name house;
	file "house.csv";
}

// object inverter {
//   name inv_bat;
//   parent Load_Meter;
//   phases AS;
//   generator_status ONLINE;
//   generator_mode CONSTANT_PQ;
//   inverter_type FOUR_QUADRANT;
// //   four_quadrant_control_mode VOLT_VAR;
//   four_quadrant_control_mode CONSTANT_PQ; // LOAD FOLLOWING
//   charge_lockout_time 1;
//   discharge_lockout_time 1;
//   sense_object Load_Meter;
//   charge_on_threshold -200.000;
//   charge_off_threshold 0.000;
//   discharge_off_threshold 4000.000;
//   discharge_on_threshold 6000.000;
//   inverter_efficiency 0.975;
//   V_base 208.000;
//   rated_power 4500.000;
//   max_charge_rate 10000.000;
//   max_discharge_rate 10000.000;
//   P_Out player_A.value;
//   Q_Out 0.000;
//   object battery {
//     name bat;
//     nominal_voltage 48;
//     battery_capacity 50000.0;
//     state_of_charge 1.0000;
//     use_internal_battery_model true;
//     generator_mode CONSTANT_PQ;
//     generator_status ONLINE;
//     battery_type LI_ION;
//     round_trip_efficiency 0.86;
//     rated_power 10000.000;
//   };
// }